AWSTemplateFormatVersion: 2010-09-09
Description: >-
  This template is a child template to both the aws-tap-entrypoint.newvpc and
  aws-tap-entrypoint.existingvpc templates with all parameters being passed
  from those parent templates. This template will focus on the creation of an
  EC2 instance that can be used to Bootstrap the install and configure TAP. The
  EC2 instance will contain a large script that will install all of the CLI
  components necessary and then perform all of the installation steps as
  defined within the TAP Installation guide for deploying into AWS. It will
  also make sure that all of the images used for TAP are stored within ECR.
  (qs-1t1t2pssu)
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for the Bootstrap instance.
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Subnet ID to which the Bootstrap instance will be connected.
  # BootstrapOS:
  #   Type: String
  #   Description: >-
  #     Preferred OS for the Bootstrap EC2 instance based on available values.
  #   AllowedValues:
  #     - Ubuntu
  #   Default: Ubuntu
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: >-
      The name of the SSH key that will be used to access the Bootstrap
      instance when it is created.
  EgressFromPort:
    Type: Number
    Description: >-
      Start of port range for outbound access of the Bootstrap VM (default 0).
    Default: 0
  EgressToPort:
    Type: Number
    Description: >-
      End of port range for outbound access of the Bootstrap VM
      (default 65535).
    Default: 65535
  EgressCidr:
    Type: String
    Description: >-
      IP range for outbound access of the Bootstrap VM
      (default is full and open to guarantee installation success).
    Default: 0.0.0.0/0
  SshPort:
    Type: Number
    Description: >-
      Port number to be used for SSH connectivity to the Bootstrap VM.
    MinValue: 0
    MaxValue: 65535
    Default: 22
  IngressCidr:
    Type: String
    Description: >-
      CIDR block that is permitted inbound SSH connectivity to the Bootstrap
      instance.
  # TanzuNetID:
  #   Type: String
  #   Description: >-
  #     The authentication ID or email address for authenticating to
  #     VMware's Tanzu Net.
  #   NoEcho: true
  # TanzuNetKey:
  #   Type: String
  #   Description: >-
  #     The authentication Key for authenticating to VMware's Tanzu Net.
  #   NoEcho: true
  # TanzuNetToken:
  #   Type: String
  #   Description: >-
  #     The authentication token required for certain TAP installation utilities
  #     within the Bootstrap VM.
  #   NoEcho: true
  # AWSCLIToken:
  #   Type: String
  #   Description: AWS Token ID used when authenticating with the AWS CLI.
  #   NoEcho: true
  # AWSCLIKey:
  #   Description: AWS Token Key used when authenticating with the AWS CLI.
  #   Type: String
  #   NoEcho: true
Resources:
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Ref AWS::StackName
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway
  PublicSubnetRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: Public Subnet Route Table
  PublicSubnetRoute:
    DependsOn: AttachGateway
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PublicSubnetRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
  BootstrapSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref BootstrapSubnet
      RouteTableId: !Ref PublicSubnetRouteTable
  ClusterSubnetACL:
    Type: AWS::EC2::NetworkAcl
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: TAPClusterACL
  InboundRuleSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 100
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 22
        To: 22
  InboundRuleK8S:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 110
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 6443
        To: 6443
  InboundRuleUI:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 120
      RuleAction: allow
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 443
        To: 443
  OutboundRuleSSH:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 100
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 22
        To: 22
  OutboundRuleK8S:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 110
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 6443
        To: 6443
  OutboundRuleUI:
    Type: AWS::EC2::NetworkAclEntry
    Properties:
      NetworkAclId: !Ref ClusterSubnetACL
      RuleNumber: 120
      RuleAction: allow
      Egress: true
      CidrBlock: 0.0.0.0/0
      Protocol: 6
      PortRange:
        From: 443
        To: 443
  BootstrapSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enables SSH access to the Bootstrap instance
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref SshPort
          ToPort: !Ref SshPort
          CidrIp: !Ref IngressCidr
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: !Ref EgressFromPort
          ToPort: !Ref EgressToPort
          CidrIp: !Ref EgressCidr
      Tags:
        - Key: Name
          Value: BootstrapSecurityGroup
  BootstrapEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: BootstrapEIP
  BootstrapInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: m5.large
      ImageId: ami-0892d3c7ee96c0bf7
      KeyName: !Ref KeyPairName
      Monitoring: true
      SecurityGroupIds:
        - !Ref BootstrapSecurityGroup
      SubnetId: !Ref SubnetId
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      Tags:
        - Key: Name
          Value: BootstrapEC2
  BootstrapEIPAssoc:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref BootstrapInstance
      AllocationId: !GetAtt BootstrapEIP.AllocationId
