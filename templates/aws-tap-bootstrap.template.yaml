AWSTemplateFormatVersion: 2010-09-09
Description: >-
  This template is a child template to both the aws-tap-entrypoint.newvpc and
  aws-tap-entrypoint.existingvpc templates with all parameters being passed
  from those parent templates. This template will focus on the creation of an
  EC2 instance that can be used to Bootstrap the install and configure TAP. The
  EC2 instance will contain a large script that will install all of the CLI
  components necessary and then perform all of the installation steps as
  defined within the TAP Installation guide for deploying into AWS. It will
  also make sure that all of the images used for TAP are stored within ECR.
  (qs-1t1t2pssu)
Metadata:
  SentenceCaseExclude:
    - Bootstrap
    - Net
    - Tanzu
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: VPC network configuration
        Parameters:
          - VpcId
          - SubnetId
      - Label:
          default: Bootstrap EC2 instance configuration
        Parameters:
          - OS
          - KeyPairName
          - SshPort
          - IngressCidr
          - EgressFromPort
          - EgressToPort
          - EgressCidr
      # - Label:
      #     default: VMware Tanzu Net authentication configuration
      #   Parameters:
      #     - TanzuNetID
      #     - TanzuNetToken
      #     - TanzuNetKey
    ParameterLabels:
      VpcId:
        default: VPC ID
      SubnetId:
        default: Subnet ID
      OS:
        default: OS
      KeyPairName:
        default: SSH key name
      SshPort:
        default: SSH port
      IngressCidr:
        default: Ingress CIDR
      EgressFromPort:
        default: Egress from port
      EgressToPort:
        default: Egress to port
      EgressCidr:
        default: Egress CIDR
      # TanzuNetID:
      #   default: ID
      # TanzuNetKey:
      #   default: Key
      # TanzuNetToken:
      #   default: Token
Parameters:
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC ID for the Bootstrap instance.
  SubnetId:
    Type: AWS::EC2::Subnet::Id
    Description: Subnet ID to which the Bootstrap instance will be connected.
  OS:
    Type: String
    Description: >-
      Preferred operating system for the Bootstrap EC2 instance based on
      available values.
    AllowedValues:
      - Ubuntu-Server-22.04-LTS-HVM
    Default: Ubuntu-Server-22.04-LTS-HVM
  KeyPairName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: >-
      The name of the SSH key that will be used to access the Bootstrap
      instance when it is created.
  EgressFromPort:
    Type: Number
    Description: >-
      Start of port range for outbound access of the Bootstrap VM (default 0).
    Default: 0
  EgressToPort:
    Type: Number
    Description: >-
      End of port range for outbound access of the Bootstrap VM
      (default 65535).
    Default: 65535
  EgressCidr:
    Type: String
    Description: >-
      IP range for outbound access of the Bootstrap VM
      (default is full and open to guarantee installation success).
    Default: 0.0.0.0/0
  SshPort:
    Type: Number
    Description: >-
      Port number to be used for SSH connectivity to the Bootstrap VM.
    MinValue: 0
    MaxValue: 65535
    Default: 22
  IngressCidr:
    Type: String
    Description: >-
      CIDR block that is permitted inbound SSH connectivity to the Bootstrap
      instance.
  # TanzuNetID:
  #   Type: String
  #   Description: >-
  #     The authentication ID or email address for authenticating to
  #     VMware's Tanzu Net.
  #   NoEcho: true
  # TanzuNetKey:
  #   Type: String
  #   Description: >-
  #     The authentication Key for authenticating to VMware's Tanzu Net.
  #   NoEcho: true
  # TanzuNetToken:
  #   Type: String
  #   Description: >-
  #     The authentication token required for certain TAP installation utilities
  #     within the Bootstrap VM.
  #   NoEcho: true
Mappings:
  AwsAmiRegionMap:
    # Ubuntu Server lookup: https://cloud-images.ubuntu.com/locator/ec2/
    af-south-1:
      US2204HVM: ami-08a1ff0efd6690ede
    ap-east-1:
      US2204HVM: ami-0c5b035581d9859b0
    ap-northeast-1:
      US2204HVM: ami-055bb115702a738f5
    ap-northeast-2:
      US2204HVM: ami-05b9c9c0fe2f5a62c
    ap-northeast-3:
      US2204HVM: ami-0b3874967694fae86
    ap-south-1:
      US2204HVM: ami-00d095fb90db2fa00
    ap-southeast-1:
      US2204HVM: ami-00c76c78e78a3dcd4
    ap-southeast-2:
      US2204HVM: ami-0251cb389d14767a2
    ap-southeast-3:
      US2204HVM: ami-0de46ab389596d621
    ca-central-1:
      US2204HVM: ami-0204f3c59456ea9a1
    # cn-north-1:
    #   US2204HVM:
    # cn-northwest-1:
    #   US2204HVM:
    eu-central-1:
      US2204HVM: ami-04aa66cdfe687d427
    eu-north-1:
      US2204HVM: ami-0dbac3c76b4ead6c5
    eu-south-1:
      US2204HVM: ami-0fe7a5523599f4c08
    eu-west-1:
      US2204HVM: ami-07bd2fc45c8a8dd48
    eu-west-2:
      US2204HVM: ami-033c8ef001424a6d3
    eu-west-3:
      US2204HVM: ami-00e43f192e8c59874
    me-south-1:
      US2204HVM: ami-0d49942d3daf970df
    sa-east-1:
      US2204HVM: ami-0b54d646bcf381a79
    us-east-1:
      US2204HVM: ami-09db26f1ef0a9f406
    us-east-2:
      US2204HVM: ami-07a683b72d6bd7da3
    us-gov-east-1:
      US2204HVM: ami-08fcbec75b43330b7
    us-gov-west-1:
      US2204HVM: ami-04e77113f128920b2
    us-west-1:
      US2204HVM: ami-09596c63850a1bd49
    us-west-2:
      US2204HVM: ami-0437ae8a23be4e98b
  LinuxAmiNameMap:
    Ubuntu-Server-22.04-LTS-HVM:
      Code: US2204HVM
Resources:
  BootstrapSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enables SSH access to the Bootstrap instance
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref SshPort
          ToPort: !Ref SshPort
          CidrIp: !Ref IngressCidr
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: !Ref EgressFromPort
          ToPort: !Ref EgressToPort
          CidrIp: !Ref EgressCidr
      Tags:
        - Key: Name
          Value: BootstrapSecurityGroup
  BootstrapEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: BootstrapEIP
  BootstrapInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: m5.large
      ImageId: !FindInMap
        - AwsAmiRegionMap
        - !Ref AWS::Region
        - !FindInMap
          - LinuxAmiNameMap
          - !Ref OS
          - Code
      KeyName: !Ref KeyPairName
      Monitoring: true
      SecurityGroupIds:
        - !Ref BootstrapSecurityGroup
      SubnetId: !Ref SubnetId
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      Tags:
        - Key: Name
          Value: BootstrapEC2
  BootstrapEIPAssoc:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref BootstrapInstance
      AllocationId: !GetAtt BootstrapEIP.AllocationId
